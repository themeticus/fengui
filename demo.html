<html>

<body>
    <h1>Group Chat</h1>

    <form id="sign">
        <input id="alias" placeholder="username">
        <input id="pass" type="password" placeholder="passphrase">
        <input id="in" type="submit" value="sign in">
        <input id="up" type="button" value="sign up">
    </form>

    <form id="room">
        <input id="roomName" placeholder="Enter room name">
        <input id="joinRoom" type="submit" value="Join Room">
    </form>

    <h2>Room: <span id="currentRoom">None</span></h2>

    <ul id="messages"></ul>

    <form id="said">
        <input id="say" placeholder="Type your message">
        <input id="speak" type="submit" value="Send">
    </form>

    <script src="https://cdn.jsdelivr.net/npm/gun/examples/jquery.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/gun/lib/webrtc.js"></script> -->
    <script>
        var gun = Gun(['http://localhost:8765/gun']);
        var user = gun.user();
        var currentRoom = '';

        $('#up').on('click', function (e) {
            user.create($('#alias').val(), $('#pass').val(), function (ack) {
                if (ack.err) {
                    console.error('Sign-up error:', ack.err);
                } else {
                    console.log('User created:', ack);
                }
            });
        });

        $('#sign').on('submit', function (e) {
            e.preventDefault();
            user.auth($('#alias').val(), $('#pass').val(), function (ack) {
                if (ack.err) {
                    console.error('Authentication error:', ack.err);
                } else {
                    console.log('User authenticated:', ack);
                }
            });
        });

        $('#room').on('submit', function (e) {
            e.preventDefault();
            if (user.is) {
                currentRoom = $('#roomName').val();
                $('#currentRoom').text(currentRoom);
                $('#said').show();
                $('#room').hide();
                user.get('rooms').get(currentRoom).map().on(function (data, id) {
                    UI(data, id);
                });
            }
        });

        $('#said').on('submit', function (e) {
            e.preventDefault();
            if (user.is && currentRoom) {
                user.get('rooms').get(currentRoom).set({ text: $('#say').val(), user: user.is.alias });
                $('#say').val("");
            }
        });

        function UI(message, id) {
            var li = $('#' + id).get(0) || $('<li>').attr('id', id).appendTo('#messages');
            $(li).text(message.text + ' (' + message.user + ')');
        }

        gun.on('auth', function () {
            $('#sign').hide();
            $('#room').show();
            $('#said').hide();
        });
    </script>
</body>

</html>