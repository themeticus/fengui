<html>

<body>
    <input id="message" placeholder="Type your message" />
    <button onclick="sendMessage()">Send</button>
    <ul id="messages"></ul>

    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <script>
        const MAX_MESSAGES = 10; // Maximum number of messages to display
        const gun = Gun(['https://themeticus.github.io/fengui/'])
        // const gun = Gun(['https://gun-manhattan.herokuapp.com/gun']);
        const messages = gun.get('messages');
        const messageBuffer = [];

        // Debounce function to limit the rate of updates
        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // Function to update the DOM
        const updateDOM = debounce(() => {
            const ul = document.getElementById('messages');
            ul.innerHTML = ''; // Clear existing messages
            messageBuffer.forEach(data => {
                const li = document.createElement('li');
                // Check if data is an object and has a `text` property
                li.textContent = typeof data === 'object' && data.text ? data.text : data;
                ul.appendChild(li);
            });
        }, 200); // Adjust delay as needed

        // Handle incoming messages
        messages.map().on(function (data, id) {
            if (data) {
                // Add new message to buffer
                messageBuffer.push(data);
                // Keep the buffer size within limits
                if (messageBuffer.length > MAX_MESSAGES) {
                    messageBuffer.shift(); // Remove oldest message
                }
                // Update the DOM
                updateDOM();
            }
        });

        function sendMessage() {
            const msg = document.getElementById('message').value;
            if (msg) {
                messages.set({ text: msg }); // Store as an object with `text` property
                document.getElementById('message').value = '';
            }
        }
    </script>
</body>

</html>